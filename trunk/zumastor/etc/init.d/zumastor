#!/bin/bash
# Zumastor Linux Storage Server
# Copyright (c) 2006 Google Inc.
# Author: Daniel Phillips <phillips@google.com>
# Licensed under the GNU GPL version 2

. /lib/lsb/init-functions
. /lib/zumastor/common
. /lib/zumastor/ddfake

function start_zumastor {
	echo Starting zumastor
	local -r agents=/var/run/zumastor/agents
	local -r servers=/var/run/zumastor/servers
	local vol

	if ! [ -d /var/run/zumastor ]; then
		mkdir -p $agents || return 1
		mkdir -p $servers || return 1
		mkdir -p /var/run/zumastor/cron || return 1
	fi
	for vol in $(ls $VOLUMES) ; do
		start_volume $vol || return 1
		create_device $vol -1 || return 1
		local -r list=$(ddsnap status $servers/$vol --list) || return 1
		local id
		for id in $list ; do
			create_device $vol $id || return 1
		done
		if test -x $VOLUMES/$vol/master; then
			zumastor start master $vol
		fi
		for host in $(ls $VOLUMES/$vol/targets) ; do
			zumastor start target $vol $host
		done
	done
}

function stop_zumastor {
	echo Stopping zumastor
	local -r servers=/var/run/zumastor/servers
	local vol

	for vol in $(ls $VOLUMES) ; do
		for host in $(ls $VOLUMES/$vol/targets) ; do
			zumastor stop target $vol $host
		done
		if test -x $VOLUMES/$vol/master; then
			zumastor stop master $vol
		fi
		local -r list=$(ddsnap status $servers/$vol --list)
		local id
		for id in $list ; do
			remove_device $vol $id
		done
		remove_device $vol -1
		stop_volume $vol
	done
}

VOLUMES=/var/lib/zumastor/volumes

test -x $VOLUMES || exit 1

case $1 in
start)
	start_zumastor
	;;
stop)
	stop_zumastor
	;;
restart|force-reload)
	stop_zumastor || exit
	start_zumastor
	;;
status)
	exit 0
	;;
*)
	echo "Usage: $0 {start|stop|restart|force-reload}"
	exit 2
	;;
esac
